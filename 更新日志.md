# 📝 CrazyCrates - KillGoddess 定制版 更新日志

## 版本历史

---

## v5.0.14 (2026-02-05) - KillGoddess 定制版

### ✨ 新增功能

#### 🎰 RandomBox 抽奖动画
- **传送带风格动画**: 完美复刻 random-box-master 插件的抽奖体验
- **动画细节**:
  - 物品从右向左滚动（传送带效果）
  - 28个物品槽位，4行×7列布局
  - 4段变速控制：快速(30×1tick) → 中速(20×2ticks) → 慢速(10×4ticks) → 极慢(5×8ticks)
  - 总动画时长：150 ticks = 7.5 秒
  - 最终奖品停在第31号槽位（中心位置）
- **界面设计**:
  - 54格界面（6行×9列）
  - 灰色玻璃板边框装饰
  - 支持自定义边框物品
- **完美兼容**: 全面支持保底系统

#### 🎁 五连抽功能
- **操作方式**: 按住 Shift + 右键点击箱子
- **智能检测**:
  - 自动检查玩家是否拥有至少5把钥匙
  - 支持物理钥匙和虚拟钥匙混合使用
  - 钥匙不足时显示中文提示消息
- **保底计数**: 每次抽取都正确累计保底进度
- **即时发放**: 直接给予5个奖品，无需等待动画
- **实现位置**: `CrateInteractListener.java`

#### 🎲 保底系统（单层机制）
- **核心功能**:
  - 每个箱子独立计数
  - 每个奖品可单独设置保底次数
  - 达到保底次数时，从所有保底奖品中随机选择一个
  - 触发保底后自动重置计数
- **配置选项**:
  ```yaml
  Prizes:
    LegendaryPrize:
      Guaranteed: true          # 标记为保底奖品
      GuaranteedCount: 100      # 100次必出
  ```
- **可视化提示**:
  - 触发保底时显示华丽的 Title 动画
  - 聊天栏显示详细的保底触发消息
  - 包含当前开箱次数信息
- **数据存储**: 保存在 `data.yml` 的 `Players.<UUID>.OpenCount.<crateName>` 路径
- **PlaceholderAPI 支持**: `%crazycrates_<箱子名>_pity_count%`
- **实现位置**:
  - `Prize.java` - 添加 `isGuaranteed` 和 `guaranteedCount` 字段
  - `Crate.java` - 修改 `pickPrize()` 方法实现保底逻辑
  - `BukkitUserManager.java` - 添加 `getOpenCount()`, `addOpenCount()`, `resetOpenCount()` 方法

### 🐛 Bug 修复

#### Purpur 1.21.4 兼容性修复
- **问题**: 插件在 Purpur 1.21.4 上启动失败，报错 `NoSuchFieldError: UNBREAKABLE`
- **原因**: Fusion 库的 `BaseItemBuilder.setUnbreakable()` 使用了 Paper 1.21.8 的新 API
- **解决方案**:
  - 在所有 `setUnbreakable()` 调用处添加 try-catch 包装
  - 捕获 `NoSuchFieldError` 异常并静默忽略
  - 保持向下兼容 Paper 1.21.4-1.21.7
- **影响文件**:
  - `ItemUtils.java`
  - `Prize.java`
  - 其他使用 `setUnbreakable()` 的类

#### 不可变集合修复
- **问题**: 使用 `List.of()` 创建的集合无法修改，导致 `UnsupportedOperationException`
- **解决方案**: 将 `List.of()` 改为 `new ArrayList<>(List.of())`
- **影响文件**: 多个使用集合的类

#### 保底系统 Bug 修复
- **问题**: 首次开箱就触发保底（计数逻辑错误）
- **原因**: `addOpenCount()` 在保底检查之后调用
- **解决方案**: 将 `addOpenCount()` 移到保底检查之前
- **修复时间**: v5.0.14 开发期间

### 📚 文档更新

#### 新增中文文档
- `RandomBox箱子使用说明.md` - RandomBox 动画完整使用指南
- `RandomBox配置示例说明.md` - 配置文件详细说明和示例
- `更新日志_v5.0.13.md` - v5.0.13 版本的更新记录
- `上传到GitHub指南.md` - GitHub 上传教程（3种方法）
- `README.md` - 完全重写，添加中文说明和项目信息

#### 配置文件示例
- `RandomBox.yml` - 标准 RandomBox 配置（10个奖品）
- `RandomBoxExample.yml` - 完整示例配置（14个奖品，4个稀有度）

### 🔧 技术改进

#### 代码质量
- 添加详细的中文注释
- 优化保底系统逻辑
- 改进错误处理机制
- 统一代码风格

#### 性能优化
- 优化动画刷新逻辑
- 减少不必要的配置读取
- 改进集合操作效率

### 🗑️ 移除内容

#### 移除的抽奖动画（v5.0.14 开发期间）
由于存在大量 Bug，以下动画已被完全移除：
- ❌ SpiralCrate（螺旋动画）
- ❌ MatrixCrate（矩阵动画）
- ❌ SlotMachineCrate（老虎机动画）

**移除原因**:
- 音效系统不工作
- 动画卡顿和闪烁
- 奖品显示错误
- 用户反馈："BUG满天飞！！！连音效都没有！？"

---

## v5.0.13 及更早版本

这些版本来自原始的 CrazyCrew/CrazyCrates 项目。

详细的历史更新日志请查看：
- `HISTORY.md` - 完整历史记录
- `changelog.md` - 变更日志
- 原项目仓库: https://github.com/Crazy-Crew/CrazyCrates

---

## 🔮 计划中的功能

### 未来版本可能添加的功能

#### 多层保底系统（原神风格）
- 多个稀有度层级（普通、稀有、史诗、传说）
- 每个层级独立计数
- 保底继承机制
- 智能重置：抽到高稀有度时重置低稀有度计数

**状态**: 已设计但未实现（代码未保存）

#### 更多动画效果
- 改进现有动画的流畅度
- 添加粒子效果
- 自定义音效支持

#### 数据统计
- 玩家抽奖历史记录
- 奖品掉落统计
- 保底触发次数统计

---

## 📊 版本对比

| 功能 | 原版 CrazyCrates | KillGoddess 定制版 |
|------|-----------------|-------------------|
| 基础抽奖功能 | ✅ | ✅ |
| 多种动画类型 | ✅ (12种) | ✅ (12种) |
| RandomBox 动画 | ❌ | ✅ |
| 五连抽功能 | ❌ | ✅ |
| 保底系统 | ❌ | ✅ (单层) |
| Purpur 1.21.4 兼容 | ⚠️ (有问题) | ✅ (完美兼容) |
| 中文文档 | ❌ | ✅ (完整) |
| PlaceholderAPI 保底变量 | ❌ | ✅ |

---

## 🤝 贡献者

### KillGoddess 定制版开发者
- **KillGoddess** - 所有新功能的开发和实现

### 原始项目贡献者
- **CrazyCrew** 团队 - 原始插件开发
- 所有为原项目做出贡献的开发者

---

## 📞 支持与反馈

### 本定制版
- **GitHub Issues**: https://github.com/KillGoddess/zoo/issues
- **维护者**: KillGoddess

### 原始项目
- **官方 Discord**: https://discord.gg/badbones-s-live-chat-182615261403283459
- **官方文档**: https://docs.crazycrew.us/docs/plugins/crazycrates
- **GitHub Issues**: https://github.com/Crazy-Crew/CrazyCrates/issues

---

## 📄 开源协议

本项目继承原项目的 MIT 协议。

- 原始项目版权所有 (c) 2016-2024 CrazyCrew
- 修改版本版权所有 (c) 2026 KillGoddess

---

<div align="center">

**感谢使用 CrazyCrates - KillGoddess 定制版！**

如果觉得有用，请给个 ⭐ Star！

</div>
